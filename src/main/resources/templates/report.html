<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather Report</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial;
      margin: 2rem;
    }

    .card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1.25rem;
      max-width: 1024px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      margin: 0 auto;
    }

    h1 {
      margin-top: 0;
      font-size: 1.5rem;
    }

    .muted {
      color: #666;
    }

    .charts {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 900px) {
      .charts {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 900px) {
      .charts {
        grid-template-columns: 1fr;
      }
    }

    .chart {
      width: 100%;
      height: 360px;
      border: 1px solid #f0f0f0;
      border-radius: 6px;
    }

    @media (max-width: 600px) {
      body {
        margin: 0.5rem;
      }

      .card {
        max-width: 100%;
        padding: 0.75rem;
        box-sizing: border-box;
      }

      h1 {
        font-size: 1.1rem;
      }

      .chart {
        height: 220px;
      }
    }

    .back {
      margin-bottom: 1rem;
      display: inline-block;
    }

    .error {
      color: #b00020;
      font-weight: 600;
    }
  </style>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
  <div class="card">
    <a href="/" class="back">← Back</a>
    <h1>
      Weather report
      <span th:if="${city}">for <span th:text="${city}"></span></span>
      (<span id="lat-value" th:text="${lat}">lat</span>, <span id="lon-value" th:text="${lon}">lon</span>)
    </h1>
    <p class="muted">Timezone: <span id="timezone">auto</span></p>

    <div th:if="${error}" id="server-error" class="error" th:text="${error}">An error occurred</div>
    <div id="client-error" class="error" style="display:none"></div>

    <div id="loading" class="muted">Loading weather data…</div>

    <div id="charts" class="charts" style="display:none">
      <div id="tempChart" class="chart"></div>
      <div id="precipChart" class="chart"></div>
      <div id="windChart" class="chart"></div>
      <div id="humidityChart" class="chart"></div>
    </div>

    <script>
      // Load Google Charts
      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(initReport);

      let chartDataCache = {};

      function initReport() {
        // If server-side validation failed, don't attempt client fetch
        if (document.getElementById('server-error')) {
          document.getElementById('loading').style.display = 'none';
          return;
        }
        const latText = (document.getElementById('lat-value')?.textContent || '').trim();
        const lonText = (document.getElementById('lon-value')?.textContent || '').trim();
        const lat = parseFloat(latText);
        const lon = parseFloat(lonText);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
          showClientError('Invalid coordinates.');
          return;
        }
        fetchAndDraw(lat, lon);
      }

      async function fetchAndDraw(lat, lon) {
        const url = new URL('https://api.open-meteo.com/v1/forecast');
        url.searchParams.set('latitude', lat);
        url.searchParams.set('longitude', lon);
        url.searchParams.set('hourly', [
          'temperature_2m',
          'precipitation',
          'wind_speed_10m',
          'relative_humidity_2m'
        ].join(','));
        url.searchParams.set('forecast_days', '3');
        url.searchParams.set('timezone', 'auto');

        try {
          const resp = await fetch(url.toString());
          if (!resp.ok) throw new Error('Weather API request failed');
          const data = await resp.json();
          const hourly = data.hourly || {};
          // Update timezone display
          const tz = data.timezone || 'auto';
          const tzEl = document.getElementById('timezone');
          if (tzEl) tzEl.textContent = tz;

          if (!hourly.time || !hourly.temperature_2m) {
            throw new Error('Incomplete data from weather API');
          }

          // Helper to convert ISO datetime string to JS Date
          const toDate = (s) => new Date(String(s));

          // Prepare data for charts and cache for redraw
          chartDataCache = {
            tempChart: {
              type: 'LineChart',
              title: 'Temperature 2m (°C)',
              columns: ['Time', 'Temperature (°C)'],
              rows: hourly.time.map((t, i) => [toDate(t), safeNumber(hourly.temperature_2m[i])])
            },
            precipChart: {
              type: 'ColumnChart',
              title: 'Precipitation (mm)',
              columns: ['Time', 'Precipitation (mm)'],
              rows: hourly.time.map((t, i) => [toDate(t), safeNumber(hourly.precipitation?.[i])])
            },
            windChart: {
              type: 'LineChart',
              title: 'Wind speed 10m (m/s)',
              columns: ['Time', 'Wind speed (m/s)'],
              rows: hourly.time.map((t, i) => [toDate(t), safeNumber(hourly.wind_speed_10m?.[i])])
            },
            humidityChart: {
              type: 'LineChart',
              title: 'Relative humidity 2m (%)',
              columns: ['Time', 'Humidity (%)'],
              rows: hourly.time.map((t, i) => [toDate(t), safeNumber(hourly.relative_humidity_2m?.[i])])
            }
          };

          document.getElementById('loading').style.display = 'none';
          document.getElementById('charts').style.display = '';
          redrawAllCharts();
        } catch (e) {
          console.error(e);
          showClientError('Failed to fetch weather data. Please try again later.');
        }
      }

      function showClientError(message) {
        document.getElementById('loading').style.display = 'none';
        const el = document.getElementById('client-error');
        el.textContent = message || 'An error occurred';
        el.style.display = '';
      }

      function safeNumber(v) {
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      }

      function redrawAllCharts() {
        for (const [id, chartInfo] of Object.entries(chartDataCache)) {
          if (chartInfo.type === 'LineChart') {
            drawLineChart(id, chartInfo.title, chartInfo.columns, chartInfo.rows);
          } else if (chartInfo.type === 'ColumnChart') {
            drawColumnChart(id, chartInfo.title, chartInfo.columns, chartInfo.rows);
          }
        }
      }

      function drawLineChart(elementId, title, columns, rows) {
        const data = new google.visualization.DataTable();
        data.addColumn('datetime', columns[0]);
        data.addColumn('number', columns[1]);
        rows.forEach(r => data.addRow(r));
        const options = {
          title: title,
          legend: { position: 'none' },
          height: document.getElementById(elementId)?.offsetHeight || 360,
          width: document.getElementById(elementId)?.offsetWidth || undefined,
          hAxis: { format: 'M/d HH:mm' },
          chartArea: { left: 60, top: 40, width: '80%', height: '70%' }
        };
        const chart = new google.visualization.LineChart(document.getElementById(elementId));
        chart.draw(data, options);
      }

      function drawColumnChart(elementId, title, columns, rows) {
        const data = new google.visualization.DataTable();
        data.addColumn('datetime', columns[0]);
        data.addColumn('number', columns[1]);
        rows.forEach(r => data.addRow(r));
        const options = {
          title: title,
          legend: { position: 'none' },
          height: document.getElementById(elementId)?.offsetHeight || 360,
          width: document.getElementById(elementId)?.offsetWidth || undefined,
          hAxis: { format: 'M/d HH:mm' },
          chartArea: { left: 60, top: 40, width: '80%', height: '70%' }
        };
        const chart = new google.visualization.ColumnChart(document.getElementById(elementId));
        chart.draw(data, options);
      }

      // Redraw charts on window resize
      window.addEventListener('resize', () => {
        if (Object.keys(chartDataCache).length > 0) {
          redrawAllCharts();
        }
      });
    </script>
  </div>
</body>

</html>