<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather Report</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial;
      margin: 2rem;
    }

    .card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1.25rem;
      max-width: 1024px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      margin: 0 auto;
    }

    h1 {
      margin-top: 0;
      font-size: 1.5rem;
    }

    .muted {
      color: #666;
    }

    .charts {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 900px) {
      .charts {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 900px) {
      .charts {
        grid-template-columns: 1fr;
      }
    }

    .chart {
      width: 100%;
      height: 360px;
      border: 1px solid #f0f0f0;
      border-radius: 6px;
    }

    @media (max-width: 600px) {
      body {
        margin: 0.5rem;
      }

      .card {
        max-width: 100%;
        padding: 0.75rem;
        box-sizing: border-box;
      }

      h1 {
        font-size: 1.1rem;
      }

      .chart {
        height: 220px;
      }
    }

    .back {
      margin-bottom: 1rem;
      display: inline-block;
    }

    .error {
      color: #b00020;
      font-weight: 600;
    }
  </style>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
  <div class="card">
    <a href="/" class="back">← Back</a>
    <h1>
      Weather report
      <span th:if="${city}">for <span id="cityName" th:text="${city}"></span></span>
      (<span th:text="${lat}">lat</span>, <span th:text="${lon}">lon</span>)
    </h1>
    <p class="muted">Timezone: <span id="tz" th:text="${timezone}">auto</span></p>

    <div th:if="${error}" class="error" th:text="${error}">An error occurred</div>

    <div id="charts" class="charts" th:if="${reportJson}">
      <div id="tempChart" class="chart"></div>
      <div id="precipChart" class="chart"></div>
      <div id="windChart" class="chart"></div>
      <div id="humidityChart" class="chart"></div>
    </div>

    <div id="aiSummary" class="card" style="margin-top: 1rem;">
      <h2 style="margin-top:0; font-size: 1.2rem;">AI summary & activity suggestions</h2>
      <div id="aiSummaryContent" class="muted">Generating AI summary…</div>
    </div>

    <script id="report-json" type="application/json" th:utext="${reportJson}">{}</script>

    <script>
      // Load Google Charts
      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(drawCharts);

      // Store chart data/options for redraw
      let chartDataCache = {};

      function drawCharts() {
        // Kick off AI summary fetch in parallel and not blocking charts
        fetchAiSummary();
        const jsonEl = document.getElementById('report-json');
        if (!jsonEl) return;
        let report;
        try {
          report = JSON.parse(jsonEl.textContent || '{}');
        } catch (e) {
          console.error('Failed to parse report JSON', e);
          return;
        }
        if (!report || !report.times || !report.temperature_2m) {
          console.warn('No report data');
          return;
        }

        // Helper to convert ISO datetime string to JS Date
        const toDate = (s) => new Date(String(s).replace(' ', 'T'));

        // Prepare data for charts and cache for redraw
        chartDataCache = {
          tempChart: {
            type: 'LineChart',
            title: 'Temperature 2m (°C)',
            columns: ['Time', 'Temperature (°C)'],
            rows: report.times.map((t, i) => [toDate(t), safeNumber(report.temperature_2m[i])])
          },
          precipChart: {
            type: 'ColumnChart',
            title: 'Precipitation (mm)',
            columns: ['Time', 'Precipitation (mm)'],
            rows: report.times.map((t, i) => [toDate(t), safeNumber(report.precipitation?.[i])])
          },
          windChart: {
            type: 'LineChart',
            title: 'Wind speed 10m (m/s)',
            columns: ['Time', 'Wind speed (m/s)'],
            rows: report.times.map((t, i) => [toDate(t), safeNumber(report.wind_speed_10m?.[i])])
          },
          humidityChart: {
            type: 'LineChart',
            title: 'Relative humidity 2m (%)',
            columns: ['Time', 'Humidity (%)'],
            rows: report.times.map((t, i) => [toDate(t), safeNumber(report.relative_humidity_2m?.[i])])
          }
        };

        redrawAllCharts();
      }

      function safeNumber(v) {
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      }

      function redrawAllCharts() {
        for (const [id, chartInfo] of Object.entries(chartDataCache)) {
          if (chartInfo.type === 'LineChart') {
            drawLineChart(id, chartInfo.title, chartInfo.columns, chartInfo.rows);
          } else if (chartInfo.type === 'ColumnChart') {
            drawColumnChart(id, chartInfo.title, chartInfo.columns, chartInfo.rows);
          }
        }
      }

      function drawLineChart(elementId, title, columns, rows) {
        const data = new google.visualization.DataTable();
        data.addColumn('datetime', columns[0]);
        data.addColumn('number', columns[1]);
        rows.forEach(r => data.addRow(r));
        const options = {
          title: title,
          legend: { position: 'none' },
          height: document.getElementById(elementId)?.offsetHeight || 360,
          width: document.getElementById(elementId)?.offsetWidth || undefined,
          hAxis: { format: 'M/d HH:mm' },
          chartArea: { left: 60, top: 40, width: '80%', height: '70%' }
        };
        const chart = new google.visualization.LineChart(document.getElementById(elementId));
        chart.draw(data, options);
      }

      function drawColumnChart(elementId, title, columns, rows) {
        const data = new google.visualization.DataTable();
        data.addColumn('datetime', columns[0]);
        data.addColumn('number', columns[1]);
        rows.forEach(r => data.addRow(r));
        const options = {
          title: title,
          legend: { position: 'none' },
          height: document.getElementById(elementId)?.offsetHeight || 360,
          width: document.getElementById(elementId)?.offsetWidth || undefined,
          hAxis: { format: 'M/d HH:mm' },
          chartArea: { left: 60, top: 40, width: '80%', height: '70%' }
        };
        const chart = new google.visualization.ColumnChart(document.getElementById(elementId));
        chart.draw(data, options);
      }

      async function fetchAiSummary() {
        const jsonEl = document.getElementById('report-json');
        const target = document.getElementById('aiSummaryContent');
        if (!jsonEl || !target) return;
        let report;
        try {
          report = JSON.parse(jsonEl.textContent || '{}');
        } catch (e) {
          target.textContent = 'AI summary unavailable (invalid report data).';
          return;
        }
        try {
          const params = new URLSearchParams();
          const tz = document.getElementById('tz')?.textContent || undefined;
          const city = document.getElementById('cityName')?.textContent || undefined;
          if (tz) params.set('timezone', tz);
          if (city) params.set('city', city);

          const resp = await fetch('/api/ai-summary' + (params.toString() ? ('?' + params.toString()) : ''), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(report)
          });
          const data = await resp.json();
          if (!resp.ok) {
            target.textContent = data?.summary || 'AI summary failed.';
            target.classList.remove('muted');
            return;
          }
          const summary = data?.summary || 'No AI summary available.';
          target.textContent = '';
          // Render as simple paragraphs, split on double newlines
          summary.split(/\n\n+/).forEach(p => {
            const para = document.createElement('p');
            para.textContent = p;
            target.appendChild(para);
          });
          target.classList.remove('muted');
        } catch (err) {
          target.textContent = 'AI summary unavailable.';
          target.classList.remove('muted');
        }
      }

      // Redraw charts on window resize
      window.addEventListener('resize', () => {
        if (Object.keys(chartDataCache).length > 0) {
          redrawAllCharts();
        }
      });
    </script>
  </div>
</body>

</html>