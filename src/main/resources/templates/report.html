<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather Report</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial; margin: 2rem; }
    .card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 1.25rem; max-width: 1024px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
    h1 { margin-top: 0; font-size: 1.5rem; }
    .muted { color: #666; }
    .charts { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    @media (min-width: 900px) { .charts { grid-template-columns: 1fr 1fr; } }
    .chart { width: 100%; height: 360px; border: 1px solid #f0f0f0; border-radius: 6px; }
    .back { margin-bottom: 1rem; display: inline-block; }
    .error { color: #b00020; font-weight: 600; }
  </style>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
<div class="card">
  <a href="/" class="back">← Back</a>
  <h1>
    Weather report
    <span th:if="${city}">for <span th:text="${city}"></span></span>
    (<span th:text="${lat}">lat</span>, <span th:text="${lon}">lon</span>)
  </h1>
  <p class="muted">Timezone: <span th:text="${timezone}">auto</span></p>

  <div th:if="${error}" class="error" th:text="${error}">An error occurred</div>

  <div id="charts" class="charts" th:if="${reportJson}">
    <div id="tempChart" class="chart"></div>
    <div id="precipChart" class="chart"></div>
    <div id="windChart" class="chart"></div>
    <div id="humidityChart" class="chart"></div>
  </div>

  <script id="report-json" type="application/json" th:text="${reportJson}">{}</script>

  <script>
    // Load Google Charts
    google.charts.load('current', {packages: ['corechart']});
    google.charts.setOnLoadCallback(drawCharts);

    function drawCharts(){
      const jsonEl = document.getElementById('report-json');
      if (!jsonEl) return;
      let report;
      try {
        report = JSON.parse(jsonEl.textContent || '{}');
      } catch (e) {
        console.error('Failed to parse report JSON', e);
        return;
      }
      if (!report || !report.times || !report.temperature_2m) {
        console.warn('No report data');
        return;
      }

      // Helper to convert ISO datetime string to JS Date
      const toDate = (s) => new Date(String(s).replace(' ', 'T'));

      // Build data tables
      drawLineChart(
        'tempChart',
        'Temperature 2m (°C)',
        ['Time', 'Temperature (°C)'],
        report.times.map((t, i) => [toDate(t), safeNumber(report.temperature_2m[i])])
      );

      drawColumnChart(
        'precipChart',
        'Precipitation (mm)',
        ['Time', 'Precipitation (mm)'],
        report.times.map((t, i) => [toDate(t), safeNumber(report.precipitation?.[i])])
      );

      drawLineChart(
        'windChart',
        'Wind speed 10m (m/s)',
        ['Time', 'Wind speed (m/s)'],
        report.times.map((t, i) => [toDate(t), safeNumber(report.wind_speed_10m?.[i])])
      );

      drawLineChart(
        'humidityChart',
        'Relative humidity 2m (%)',
        ['Time', 'Humidity (%)'],
        report.times.map((t, i) => [toDate(t), safeNumber(report.relative_humidity_2m?.[i])])
      );
    }

    function safeNumber(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function drawLineChart(elementId, title, columns, rows){
      const data = new google.visualization.DataTable();
      data.addColumn('datetime', columns[0]);
      data.addColumn('number', columns[1]);
      rows.forEach(r => data.addRow(r));
      const options = {
        title: title,
        legend: { position: 'none' },
        height: 360,
        hAxis: { format: 'M/d HH:mm' },
        chartArea: { left: 60, top: 40, width: '80%', height: '70%' }
      };
      const chart = new google.visualization.LineChart(document.getElementById(elementId));
      chart.draw(data, options);
    }

    function drawColumnChart(elementId, title, columns, rows){
      const data = new google.visualization.DataTable();
      data.addColumn('datetime', columns[0]);
      data.addColumn('number', columns[1]);
      rows.forEach(r => data.addRow(r));
      const options = {
        title: title,
        legend: { position: 'none' },
        height: 360,
        hAxis: { format: 'M/d HH:mm' },
        chartArea: { left: 60, top: 40, width: '80%', height: '70%' }
      };
      const chart = new google.visualization.ColumnChart(document.getElementById(elementId));
      chart.draw(data, options);
    }
  </script>
</div>
</body>
</html>
