<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather Report</title>
  <style>
      :root {
          color-scheme: light dark;
          --bg: #0b1020;
          --panel: #141a2f;
          --text: #e6e9f0;
          --muted: #9aa3b2;
          --primary: #4f8cff;
          --primary-contrast: #ffffff;
          --border: #23304d;
          --focus: #a3c5ff;
          --ok: #2ecc71;
          --warn: #f39c12;
          --err: #ff6b6b;
      }

      @media (prefers-color-scheme: light) {
          :root {
              --bg: #f7f9fc;
              --panel: #ffffff;
              --text: #172033;
              --muted: #51607a;
              --primary: #0d6efd;
              --primary-contrast: #ffffff;
              --border: #e5eaf2;
              --focus: #5aa1ff;
              --ok: #1f9d57;
              --warn: #c77700;
              --err: #c0392b;
          }
      }

      * {
          box-sizing: border-box;
      }

      html, body {
          height: 100%;
      }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial;
        margin: 0;
        background: radial-gradient(1200px 800px at 100% 0%, rgba(79, 140, 255, 0.12), transparent 60%),
        radial-gradient(1000px 700px at 0% 100%, rgba(71, 182, 255, 0.12), transparent 60%),
        var(--bg);
        color: var(--text);
    }

      .wrap {
          min-height: 100%;
          padding: 6vh 1rem;
      }

    .card {
        border: 1px solid var(--border);
        border-radius: 16px;
      padding: 1.25rem;
      max-width: 1024px;
      margin: 0 auto;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0)), var(--panel);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
        backdrop-filter: blur(6px);
    }

      h1 {
          margin: 0 0 .75rem 0;
          font-size: 1.5rem;
      }

      .muted {
          color: var(--muted);
      }

      .charts {
          display: grid;
          grid-template-columns: 1fr;
          gap: 1rem;
      }

      @media (min-width: 900px) {
          .charts {
              grid-template-columns: 1fr 1fr;
          }
      }

    .chart {
        width: 100%;
        height: 360px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: color-mix(in oklab, var(--panel), #ffffff 4%);
    }

    @media (max-width: 600px) {
        .wrap {
            padding: 4vh 0.75rem;
        }

        h1 {
            font-size: 1.25rem;
        }

        .chart {
            height: 240px;
        }
    }

      .back {
          margin-bottom: 1rem;
          display: inline-flex;
          align-items: center;
          gap: .5rem;
          color: var(--primary);
          text-decoration: none;
      }

      .back:hover {
          text-decoration: underline;
      }

      .error {
          color: var(--err);
          font-weight: 600;
      }

      .map-container {
          width: 100%;
          height: 340px;
          margin: 1.5rem 0;
          border-radius: 12px;
          overflow: hidden;
          border: 1px solid var(--border);
      }

      .pill {
          display: inline-block;
          padding: .25rem .6rem;
          border-radius: 999px;
          font-size: .85rem;
          border: 1px solid var(--border);
          color: var(--muted);
    }

      .grid {
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: .75rem;
      }

      @media (max-width: 700px) {
          .grid {
              grid-template-columns: 1fr;
          }
      }
  </style>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>

<body>
<div class="wrap">
    <div class="card">
        <a href="/" class="back">← Back</a>
        <h1>
            Weather report
            <span th:if="${city}">for <span th:text="${city}"></span></span>
            (<span id="lat-value" th:text="${lat}">lat</span>, <span id="lon-value" th:text="${lon}">lon</span>)
        </h1>
    <p class="muted">Timezone: <span id="timezone">auto</span></p>

    <!-- Map container -->
    <div id="map" class="map-container"></div>

    <div th:if="${error}" id="server-error" class="error" th:text="${error}">An error occurred</div>
    <div id="client-error" class="error" style="display:none"></div>

    <div id="loading" class="muted">Loading weather data…</div>

    <div id="aiSummary" class="card" style="margin-top: 1rem;">
      <h2 style="margin-top:0; font-size: 1.2rem;">AI summary & activity suggestions</h2>
      <div id="aiSummaryContent" class="muted">Generating AI summary…</div>
    </div>

    <div id="charts" class="charts" style="display:none">
      <div id="tempChart" class="chart"></div>
      <div id="precipChart" class="chart"></div>
      <div id="windChart" class="chart"></div>
      <div id="humidityChart" class="chart"></div>
    </div>

    <script id="report-json" type="application/json" th:utext="${reportJson}">{}</script>

    <script>
      // Load Google Charts
      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(initReport);

      let chartDataCache = {};

      function initReport() {
        // If server-side validation failed, don't attempt client fetch
        if (document.getElementById('server-error')) {
          document.getElementById('loading').style.display = 'none';
          return;
        }
        const latText = (document.getElementById('lat-value')?.textContent || '').trim();
        const lonText = (document.getElementById('lon-value')?.textContent || '').trim();
        const lat = parseFloat(latText);
        const lon = parseFloat(lonText);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
          showClientError('Invalid coordinates.');
          return;
        }
        initMap(lat, lon); // <-- Add this line to initialize the map
        fetchAndDraw(lat, lon);
      }

      // Initialize Leaflet map
      function initMap(lat, lon) {
        const map = L.map('map').setView([lat, lon], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
        }).addTo(map);
        L.marker([lat, lon]).addTo(map);
      }

      async function fetchAndDraw(lat, lon) {
        const url = new URL('https://api.open-meteo.com/v1/forecast');
        url.searchParams.set('latitude', lat);
        url.searchParams.set('longitude', lon);
        url.searchParams.set('hourly', [
          'temperature_2m',
          'precipitation',
          'wind_speed_10m',
          'relative_humidity_2m'
        ].join(','));
        url.searchParams.set('forecast_days', '3');
        url.searchParams.set('timezone', 'auto');

        try {
          const resp = await fetch(url.toString());
          if (!resp.ok) throw new Error('Weather API request failed');
          const data = await resp.json();
          fetchAiSummary(data)
          const hourly = data.hourly || {};
          // Update timezone display
          const tz = data.timezone || 'auto';
          const tzEl = document.getElementById('timezone');
          if (tzEl) tzEl.textContent = tz;

          if (!hourly.time || !hourly.temperature_2m) {
            throw new Error('Incomplete data from weather API');
          }

          // Helper to convert ISO datetime string to JS Date
          const toDate = (s) => new Date(String(s));

          // Prepare data for charts and cache for redraw
          chartDataCache = {
            tempChart: {
              type: 'LineChart',
              title: 'Temperature 2m (°C)',
              columns: ['Time', 'Temperature (°C)'],
              rows: hourly.time.map((t, i) => [toDate(t), safeNumber(hourly.temperature_2m[i])])
            },
            precipChart: {
              type: 'ColumnChart',
              title: 'Precipitation (mm)',
              columns: ['Time', 'Precipitation (mm)'],
              rows: hourly.time.map((t, i) => [toDate(t), safeNumber(hourly.precipitation?.[i])])
            },
            windChart: {
              type: 'LineChart',
              title: 'Wind speed 10m (m/s)',
              columns: ['Time', 'Wind speed (m/s)'],
              rows: hourly.time.map((t, i) => [toDate(t), safeNumber(hourly.wind_speed_10m?.[i])])
            },
            humidityChart: {
              type: 'LineChart',
              title: 'Relative humidity 2m (%)',
              columns: ['Time', 'Humidity (%)'],
              rows: hourly.time.map((t, i) => [toDate(t), safeNumber(hourly.relative_humidity_2m?.[i])])
            }
          };

          document.getElementById('loading').style.display = 'none';
          document.getElementById('charts').style.display = '';
          redrawAllCharts();
        } catch (e) {
          console.error(e);
          showClientError('Failed to fetch weather data. Please try again later.');
        }
      }

      function showClientError(message) {
        document.getElementById('loading').style.display = 'none';
        const el = document.getElementById('client-error');
        el.textContent = message || 'An error occurred';
        el.style.display = '';
      }

      function safeNumber(v) {
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      }

      function redrawAllCharts() {
        for (const [id, chartInfo] of Object.entries(chartDataCache)) {
          if (chartInfo.type === 'LineChart') {
            drawLineChart(id, chartInfo.title, chartInfo.columns, chartInfo.rows);
          } else if (chartInfo.type === 'ColumnChart') {
            drawColumnChart(id, chartInfo.title, chartInfo.columns, chartInfo.rows);
          }
        }
      }

      function drawLineChart(elementId, title, columns, rows) {
        const data = new google.visualization.DataTable();
        data.addColumn('datetime', columns[0]);
        data.addColumn('number', columns[1]);
        rows.forEach(r => data.addRow(r));
          const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const options = {
          title: title,
            legend: {position: 'none', textStyle: {color: isDark ? '#e6e9f0' : '#172033'}},
            backgroundColor: 'transparent',
            colors: isDark ? ['#4f8cff'] : undefined,
            titleTextStyle: {color: isDark ? '#e6e9f0' : '#172033', fontSize: 14},
          height: document.getElementById(elementId)?.offsetHeight || 360,
          width: document.getElementById(elementId)?.offsetWidth || undefined,
            hAxis: {
                format: 'M/d HH:mm',
                textStyle: {color: isDark ? '#c9d1e1' : '#51607a'},
                gridlines: {color: isDark ? '#23304d' : '#e5eaf2'},
                baselineColor: isDark ? '#23304d' : '#e5eaf2'
            },
            vAxis: {
                textStyle: {color: isDark ? '#c9d1e1' : '#51607a'},
                gridlines: {color: isDark ? '#23304d' : '#e5eaf2'},
                baselineColor: isDark ? '#23304d' : '#e5eaf2'
            },
          chartArea: { left: 60, top: 40, width: '80%', height: '70%' }
        };
        const chart = new google.visualization.LineChart(document.getElementById(elementId));
        chart.draw(data, options);
      }

      function drawColumnChart(elementId, title, columns, rows) {
        const data = new google.visualization.DataTable();
        data.addColumn('datetime', columns[0]);
        data.addColumn('number', columns[1]);
        rows.forEach(r => data.addRow(r));
          const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const options = {
          title: title,
            legend: {position: 'none', textStyle: {color: isDark ? '#e6e9f0' : '#172033'}},
            backgroundColor: 'transparent',
            colors: isDark ? ['#4f8cff'] : undefined,
            titleTextStyle: {color: isDark ? '#e6e9f0' : '#172033', fontSize: 14},
          height: document.getElementById(elementId)?.offsetHeight || 360,
          width: document.getElementById(elementId)?.offsetWidth || undefined,
            hAxis: {
                format: 'M/d HH:mm',
                textStyle: {color: isDark ? '#c9d1e1' : '#51607a'},
                gridlines: {color: isDark ? '#23304d' : '#e5eaf2'},
                baselineColor: isDark ? '#23304d' : '#e5eaf2'
            },
            vAxis: {
                textStyle: {color: isDark ? '#c9d1e1' : '#51607a'},
                gridlines: {color: isDark ? '#23304d' : '#e5eaf2'},
                baselineColor: isDark ? '#23304d' : '#e5eaf2'
            },
          chartArea: { left: 60, top: 40, width: '80%', height: '70%' }
        };
        const chart = new google.visualization.ColumnChart(document.getElementById(elementId));
        chart.draw(data, options);
      }

      async function fetchAiSummary(report) {
        const target = document.getElementById('aiSummaryContent');
        if (!report || !target) return;
        try {
          const params = new URLSearchParams();
          const tz = document.getElementById('tz')?.textContent || undefined;
          const city = document.getElementById('cityName')?.textContent || undefined;
          if (tz) params.set('timezone', tz);
          if (city) params.set('city', city);

          const resp = await fetch('/api/ai-summary' + (params.toString() ? ('?' + params.toString()) : ''), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(report)
          });
          const data = await resp.json();
          if (!resp.ok) {
            target.textContent = data?.summary || 'AI summary failed.';
            target.classList.remove('muted');
            return;
          }
          const summary = data?.summary || 'No AI summary available.';
          // Render markdown using marked.js
          target.innerHTML = marked.parse(summary);
          target.classList.remove('muted');
        } catch (err) {
          target.textContent = 'AI summary unavailable.';
          target.classList.remove('muted');
        }
      }

      // Redraw charts on window resize
      window.addEventListener('resize', () => {
        if (Object.keys(chartDataCache).length > 0) {
          redrawAllCharts();
        }
      });
    </script>
    </div>
  </div>
</body>

</html>