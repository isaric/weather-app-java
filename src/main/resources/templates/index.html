<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather App (Spring Boot + Thymeleaf + LangChain4j)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
      margin: 2rem;
    }

    .card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1.25rem;
      max-width: 720px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      margin: 0 auto;
    }

    h1 {
      margin-top: 0;
      font-size: 1.5rem;
    }

    .muted {
      color: #666;
    }

    code {
      background: #f6f8fa;
      padding: 0.15rem 0.35rem;
      border-radius: 4px;
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    label {
      font-weight: 600;
    }

    input[type="text"] {
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: 1px solid #0d6efd;
      background: #0d6efd;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .hint {
      color: #666;
      font-size: 0.9rem;
    }

    @media (max-width: 600px) {
      body {
        margin: 0.5rem;
      }

      .card {
        max-width: 100%;
        padding: 0.75rem;
        box-sizing: border-box;
      }

      h1 {
        font-size: 1.1rem;
      }

      input[type="text"],
      button {
        font-size: 0.95rem;
      }

      .form-row {
        gap: 0.35rem;
      }

      .hint {
        font-size: 0.85rem;
      }
    }
  </style>
</head>

<body>
  <div class="card">
    <h1 th:text="${message}">Welcome to Weather App!</h1>
    <hr />
    <form id="location-form" class="form-row" method="get" action="/report">
      <label for="city-input">Your town/city</label>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <input id="city-input" name="city" type="text" list="city-suggestions" placeholder="Start typing your town..."
          autocomplete="off" style="flex: 1 1 auto;" />
        <button type="button" id="geo-btn" title="Use my location" style="white-space: nowrap;">Use my location</button>
        <button type="button" id="reset-btn" style="display:none;">Reset</button>
      </div>
      <input type="hidden" id="lat" name="lat" />
      <input type="hidden" id="lon" name="lon" />
      <datalist id="city-suggestions"></datalist>
      <div class="hint">Type more than 3 characters. Select an option like
        "City CC (lat,lon)" to enable submit.</div>
      <button id="submit-btn" type="submit" disabled>Submit</button>
    </form>
  </div>

  <script>
    (function () {
      const input = document.getElementById('city-input');
      const datalist = document.getElementById('city-suggestions');
      const form = document.getElementById('location-form');
      const geoBtn = document.getElementById('geo-btn');
      const resetBtn = document.getElementById('reset-btn');
      const latEl = document.getElementById('lat');
      const lonEl = document.getElementById('lon');
      const submitBtn = document.getElementById('submit-btn');

      // Validate before submission: ensure we have parsed coordinates
      form.addEventListener('submit', function (e) {
        const lat = document.getElementById('lat').value;
        const lon = document.getElementById('lon').value;
        if (!lat || !lon) {
          e.preventDefault();
          alert('Please select a location from suggestions to include coordinates.');
          return;
        }
        // Modify city input to only send first word up to first comma
        const input = document.getElementById('city-input');
        const cityVal = input.value || '';
        // Extract up to first comma, or first word if no comma
        let cityFirstWord = cityVal.split(',')[0].trim().split(/\s+/)[0];
        input.value = cityFirstWord;
        // Ensure city input is enabled so it is included in the form submission
        input.disabled = false;
      });

      let timer = null;
      const debounce = (fn, delay = 250) => {
        return (...args) => {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(null, args), delay);
        };
      };

      function shouldSearch(text) {
        const t = (text || '').trim();
        if (!t) return false;
        const chars = t.length;
        const words = t.split(/\s+/).filter(Boolean).length;
        // The issue text says "more than 3 words"; we also allow >3 characters to be user-friendly
        return words > 3 || chars > 3;
      }

      async function fetchSuggestions(q) {
        try {
          const resp = await fetch(`/api/cities/search?q=${encodeURIComponent(q)}&limit=10`);
          if (!resp.ok) return [];
          return await resp.json();
        } catch (e) {
          return [];
        }
      }

      function setSuggestions(list) {
        datalist.innerHTML = '';
        (list || []).forEach(item => {
          const opt = document.createElement('option');
          opt.value = item; // using formatted suggestion string as the value
          datalist.appendChild(opt);
        });
      }

      const handleInput = debounce(async function (e) {
        const q = e.target.value || '';
        if (!shouldSearch(q)) {
          setSuggestions([]);
          return;
        }
        const suggestions = await fetchSuggestions(q);
        setSuggestions(suggestions);
      }, 250);

      function parseCoordsFromInput(val) {
        // Match last pair of parentheses with two numbers: (lat,lon)
        const m = (val || '').match(/\(([-+]?\d*\.?\d+),\s*([-+]?\d*\.?\d+)\)\s*$/);
        if (!m) return null;
        const lat = parseFloat(m[1]);
        const lon = parseFloat(m[2]);
        if (Number.isFinite(lat) && Number.isFinite(lon)) return { lat, lon };
        return null;
      }

      function updateStateFromInput() {
        const val = input.value || '';
        const coords = parseCoordsFromInput(val);
        const submitBtn = document.getElementById('submit-btn');
        const latEl = document.getElementById('lat');
        const lonEl = document.getElementById('lon');
        if (coords) {
          latEl.value = coords.lat;
          lonEl.value = coords.lon;
          submitBtn.disabled = false;
        } else {
          latEl.value = '';
          lonEl.value = '';
          submitBtn.disabled = true;
        }
      }

      geoBtn.addEventListener('click', function () {
        if (!navigator.geolocation) {
          alert('Geolocation is not supported by your browser.');
          return;
        }
        geoBtn.disabled = true;
        geoBtn.textContent = 'Locating...';
        navigator.geolocation.getCurrentPosition(
          async function (pos) {
            const { latitude, longitude } = pos.coords;
            latEl.value = latitude;
            lonEl.value = longitude;
            // Reverse geocode using Nominatim
            let cityLabel = '';
            try {
              const url = `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&accept-language=en`;
              const resp = await fetch(url, {
                headers: { 'User-Agent': 'weather-app-demo' }
              });
              if (resp.ok) {
                const data = await resp.json();
                // Try to get city/town/village/hamlet
                const addr = data.address || {};
                cityLabel = addr.city || addr.town || addr.village || addr.hamlet || '';
                const countryCode = addr.country_code ? addr.country_code.toUpperCase() : '';
                if (cityLabel && countryCode) {
                  cityLabel = `${cityLabel} ${countryCode}`;
                }
              }
            } catch (e) {
              // ignore, fallback below
            }
            if (!cityLabel) {
              cityLabel = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
            } else {
              cityLabel = `${cityLabel} (${latitude.toFixed(5)},${longitude.toFixed(5)})`;
            }
            input.value = cityLabel;
            // Do not disable input here, so its value is sent with the form
            // input.disabled = true;
            datalist.innerHTML = '';
            submitBtn.disabled = false;
            geoBtn.style.display = 'none';
            resetBtn.style.display = '';
            geoBtn.textContent = 'Use my location';
          },
          function (err) {
            alert('Unable to retrieve your location.');
            geoBtn.disabled = false;
            geoBtn.textContent = 'Use my location';
          }
        );
      });

      resetBtn.addEventListener('click', function () {
        input.value = '';
        input.disabled = false;
        latEl.value = '';
        lonEl.value = '';
        submitBtn.disabled = true;
        geoBtn.style.display = '';
        resetBtn.style.display = 'none';
        datalist.innerHTML = '';
      });

      input.addEventListener('input', (e) => {
        handleInput(e);
        updateStateFromInput();
      });

      // Also run on blur in case selection happens via click on datalist
      input.addEventListener('change', updateStateFromInput);

      // Init state
      updateStateFromInput();
    })();
  </script>
</body>

</html>